# Nginx Role - Main Tasks
---
- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yml"
        - "{{ ansible_distribution | lower }}.yml"
        - "{{ ansible_os_family | lower }}.yml"
      paths:
        - vars
      skip: true
  tags:
    - nginx

- name: Install Nginx (RHEL/Amazon Linux)
  ansible.builtin.yum:
    name: "{{ nginx_packages }}"
    state: present
    enablerepo: "{{ nginx_yum_repo | default(omit) }}"
  when: ansible_os_family == "RedHat"
  tags:
    - nginx
    - packages

- name: Install Nginx (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "{{ nginx_packages }}"
    state: present
  when: ansible_os_family == "Debian"
  tags:
    - nginx
    - packages

- name: Create Nginx directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - /etc/nginx/conf.d
    - /etc/nginx/sites-available
    - /etc/nginx/sites-enabled
    - /etc/nginx/ssl
    - /etc/nginx/snippets
    - "{{ nginx_static_root | default('/var/www/static') }}"
    - "{{ nginx_media_root | default('/var/www/media') }}"
    - /var/log/nginx
    - /var/cache/nginx
  tags:
    - nginx
    - directories

- name: Configure main Nginx configuration
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: "0644"
    validate: "nginx -t -c %s"
    backup: true
  notify: Reload nginx
  tags:
    - nginx
    - config

- name: Configure SSL settings snippet
  ansible.builtin.template:
    src: ssl-params.conf.j2
    dest: /etc/nginx/snippets/ssl-params.conf
    owner: root
    group: root
    mode: "0644"
  when: nginx_ssl_enabled | default(false)
  notify: Reload nginx
  tags:
    - nginx
    - ssl

- name: Deploy SSL certificates
  ansible.builtin.include_tasks: ssl.yml
  when: nginx_ssl_enabled | default(false)
  tags:
    - nginx
    - ssl

- name: Configure upstream servers
  ansible.builtin.template:
    src: upstream.conf.j2
    dest: /etc/nginx/conf.d/upstream.conf
    owner: root
    group: root
    mode: "0644"
  when: nginx_upstreams is defined and nginx_upstreams | length > 0
  notify: Reload nginx
  tags:
    - nginx
    - upstream

- name: Configure default server block
  ansible.builtin.template:
    src: default.conf.j2
    dest: /etc/nginx/conf.d/default.conf
    owner: root
    group: root
    mode: "0644"
  notify: Reload nginx
  tags:
    - nginx
    - vhosts

- name: Configure virtual hosts
  ansible.builtin.template:
    src: vhost.conf.j2
    dest: "/etc/nginx/sites-available/{{ item.server_name | replace('.', '_') }}.conf"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ nginx_vhosts | default([]) }}"
  loop_control:
    label: "{{ item.server_name }}"
  notify: Reload nginx
  tags:
    - nginx
    - vhosts

- name: Enable virtual hosts
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ item.server_name | replace('.', '_') }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ item.server_name | replace('.', '_') }}.conf"
    state: link
  loop: "{{ nginx_vhosts | default([]) }}"
  loop_control:
    label: "{{ item.server_name }}"
  when: item.enabled | default(true)
  notify: Reload nginx
  tags:
    - nginx
    - vhosts

- name: Remove disabled virtual hosts
  ansible.builtin.file:
    path: "/etc/nginx/sites-enabled/{{ item.server_name | replace('.', '_') }}.conf"
    state: absent
  loop: "{{ nginx_vhosts | default([]) }}"
  loop_control:
    label: "{{ item.server_name }}"
  when: not (item.enabled | default(true))
  notify: Reload nginx
  tags:
    - nginx
    - vhosts

- name: Deploy health check endpoint
  ansible.builtin.template:
    src: health.conf.j2
    dest: /etc/nginx/conf.d/health.conf
    owner: root
    group: root
    mode: "0644"
  notify: Reload nginx
  tags:
    - nginx
    - health

- name: Configure log rotation
  ansible.builtin.template:
    src: logrotate.j2
    dest: /etc/logrotate.d/nginx
    owner: root
    group: root
    mode: "0644"
  tags:
    - nginx
    - logging

- name: Validate Nginx configuration
  ansible.builtin.command: nginx -t
  register: nginx_config_test
  changed_when: false
  failed_when: nginx_config_test.rc != 0
  tags:
    - nginx
    - validate

- name: Ensure Nginx is enabled and running
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true
  tags:
    - nginx
    - service
