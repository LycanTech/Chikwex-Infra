# User Management Tasks
---
- name: Ensure admin groups exist
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop:
    - wheel
    - docker
    - admin

- name: Create admin users
  ansible.builtin.user:
    name: "{{ item.username }}"
    uid: "{{ item.uid | default(omit) }}"
    groups: "{{ item.groups | join(',') }}"
    append: true
    shell: "{{ item.shell | default('/bin/bash') }}"
    create_home: true
    state: present
  loop: "{{ admin_users }}"
  loop_control:
    label: "{{ item.username }}"

- name: Set up SSH authorized keys for admin users
  ansible.posix.authorized_key:
    user: "{{ item.0.username }}"
    key: "{{ item.1 }}"
    state: present
    exclusive: "{{ item.0.ssh_keys_exclusive | default(false) }}"
  loop: "{{ admin_users | subelements('ssh_keys', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.username }}"

- name: Configure sudoers for admin users
  ansible.builtin.template:
    src: sudoers_user.j2
    dest: "/etc/sudoers.d/{{ item.username }}"
    owner: root
    group: root
    mode: "0440"
    validate: "visudo -cf %s"
  loop: "{{ admin_users }}"
  loop_control:
    label: "{{ item.username }}"
  when: item.sudo | default(true)

- name: Remove deprecated users
  ansible.builtin.user:
    name: "{{ item }}"
    state: absent
    remove: true
  loop: "{{ deprecated_users | default([]) }}"
