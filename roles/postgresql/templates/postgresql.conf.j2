# PostgreSQL Configuration File
# Managed by Ansible - Do not edit manually
# {{ ansible_managed }}

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------
data_directory = '{{ postgresql_data_directory }}'
hba_file = '{{ postgresql_config_directory }}/pg_hba.conf'
ident_file = '{{ postgresql_config_directory }}/pg_ident.conf'

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------
listen_addresses = '{{ postgresql_listen_addresses | default("localhost") }}'
port = {{ postgresql_port | default(5432) }}
max_connections = {{ postgresql_max_connections | default(100) }}

#------------------------------------------------------------------------------
# MEMORY
#------------------------------------------------------------------------------
shared_buffers = {{ postgresql_shared_buffers | default('128MB') }}
effective_cache_size = {{ postgresql_effective_cache_size | default('512MB') }}
work_mem = {{ postgresql_work_mem | default('4MB') }}
maintenance_work_mem = {{ postgresql_maintenance_work_mem | default('64MB') }}

#------------------------------------------------------------------------------
# WRITE AHEAD LOG
#------------------------------------------------------------------------------
wal_level = {{ postgresql_wal_level | default('replica') }}
max_wal_senders = {{ postgresql_max_wal_senders | default(3) }}
wal_keep_size = {{ postgresql_wal_keep_size | default('64MB') }}

{% if postgresql_archive_mode | default('off') == 'on' %}
archive_mode = on
archive_command = '{{ postgresql_archive_command | default("cp %p /var/lib/pgsql/archive/%f") }}'
{% endif %}

#------------------------------------------------------------------------------
# CHECKPOINTS
#------------------------------------------------------------------------------
checkpoint_completion_target = {{ postgresql_checkpoint_completion_target | default(0.9) }}
checkpoint_timeout = {{ postgresql_checkpoint_timeout | default('5min') }}

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
logging_collector = {{ postgresql_logging_collector | default('on') }}
log_directory = '{{ postgresql_log_directory | default("log") }}'
log_filename = '{{ postgresql_log_filename | default("postgresql-%Y-%m-%d_%H%M%S.log") }}'
log_rotation_age = {{ postgresql_log_rotation_age | default('1d') }}
log_rotation_size = {{ postgresql_log_rotation_size | default('100MB') }}
log_min_duration_statement = {{ postgresql_log_min_duration_statement | default(-1) }}
log_checkpoints = {{ postgresql_log_checkpoints | default('off') }}
log_connections = {{ postgresql_log_connections | default('off') }}
log_disconnections = {{ postgresql_log_disconnections | default('off') }}
log_lock_waits = {{ postgresql_log_lock_waits | default('off') }}
log_line_prefix = '%m [%p] %q%u@%d '
log_timezone = '{{ system_timezone | default("UTC") }}'

#------------------------------------------------------------------------------
# STATISTICS
#------------------------------------------------------------------------------
shared_preload_libraries = '{{ postgresql_shared_preload_libraries | default("pg_stat_statements") }}'
pg_stat_statements.track = all

#------------------------------------------------------------------------------
# LOCALE AND FORMATTING
#------------------------------------------------------------------------------
datestyle = 'iso, mdy'
timezone = '{{ system_timezone | default("UTC") }}'
lc_messages = '{{ system_locale | default("en_US.UTF-8") }}'
lc_monetary = '{{ system_locale | default("en_US.UTF-8") }}'
lc_numeric = '{{ system_locale | default("en_US.UTF-8") }}'
lc_time = '{{ system_locale | default("en_US.UTF-8") }}'
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# CUSTOM SETTINGS
#------------------------------------------------------------------------------
{% if postgresql_custom_settings is defined %}
{% for setting in postgresql_custom_settings %}
{{ setting.name }} = {{ setting.value }}
{% endfor %}
{% endif %}
