# AWS Secrets Manager Integration Tasks
---
- name: Install Python boto3 for Secrets Manager
  ansible.builtin.pip:
    name:
      - boto3
      - botocore
    state: present

- name: Create secrets cache directory
  ansible.builtin.file:
    path: "{{ secrets_cache_directory | default('/var/cache/secrets') }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Deploy secrets retrieval script
  ansible.builtin.template:
    src: get_secret.py.j2
    dest: /opt/scripts/get_secret.py
    owner: root
    group: root
    mode: "0755"

- name: Deploy secrets refresh script
  ansible.builtin.template:
    src: refresh_secrets.sh.j2
    dest: /opt/scripts/refresh_secrets.sh
    owner: root
    group: root
    mode: "0755"

- name: Fetch and cache application secrets
  ansible.builtin.command: >
    /opt/scripts/get_secret.py
    --secret-id {{ item.secret_id }}
    --output {{ item.output_file }}
    --format {{ item.format | default('json') }}
  loop: "{{ aws_secrets_to_fetch | default([]) }}"
  loop_control:
    label: "{{ item.secret_id }}"
  changed_when: false
  no_log: true
  when: aws_secrets_to_fetch is defined

- name: Set permissions on secret files
  ansible.builtin.file:
    path: "{{ item.output_file }}"
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0600') }}"
  loop: "{{ aws_secrets_to_fetch | default([]) }}"
  loop_control:
    label: "{{ item.output_file }}"
  when: aws_secrets_to_fetch is defined

- name: Create secrets refresh cron job
  ansible.builtin.cron:
    name: "Refresh AWS Secrets"
    minute: "0"
    hour: "*/6"
    job: "/opt/scripts/refresh_secrets.sh >> /var/log/secrets_refresh.log 2>&1"
    user: root
  when: aws_secrets_auto_refresh | default(false)
