# EC2 Instance Metadata Configuration Tasks
---
- name: Fetch EC2 instance metadata
  amazon.aws.ec2_metadata_facts:
  register: ec2_metadata
  ignore_errors: true

- name: Set EC2 metadata facts
  ansible.builtin.set_fact:
    ec2_instance_id: "{{ ansible_ec2_instance_id | default('unknown') }}"
    ec2_region: "{{ ansible_ec2_placement_region | default(aws_region) }}"
    ec2_availability_zone: "{{ ansible_ec2_placement_availability_zone | default('unknown') }}"
    ec2_instance_type: "{{ ansible_ec2_instance_type | default('unknown') }}"
    ec2_ami_id: "{{ ansible_ec2_ami_id | default('unknown') }}"
    ec2_public_ipv4: "{{ ansible_ec2_public_ipv4 | default('') }}"
    ec2_local_ipv4: "{{ ansible_ec2_local_ipv4 | default(ansible_default_ipv4.address) }}"
  when: ec2_metadata is succeeded

- name: Deploy instance metadata script
  ansible.builtin.template:
    src: instance_metadata.sh.j2
    dest: /opt/scripts/instance_metadata.sh
    owner: root
    group: root
    mode: "0755"

- name: Create instance metadata file
  ansible.builtin.template:
    src: instance_info.json.j2
    dest: /etc/instance_info.json
    owner: root
    group: root
    mode: "0644"

- name: Configure IMDSv2 requirement (optional)
  ansible.builtin.command: >
    aws ec2 modify-instance-metadata-options
    --instance-id {{ ec2_instance_id }}
    --http-tokens required
    --http-endpoint enabled
  when:
    - aws_enforce_imdsv2 | default(false)
    - ec2_instance_id != 'unknown'
  changed_when: false
