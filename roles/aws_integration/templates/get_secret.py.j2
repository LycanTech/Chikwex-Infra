#!/usr/bin/env python3
"""
AWS Secrets Manager Secret Retrieval Script
Managed by Ansible - Do not edit manually
{{ ansible_managed }}
"""

import argparse
import json
import sys

import boto3
from botocore.exceptions import ClientError


def get_secret(secret_id: str, region: str = "{{ aws_region | default('us-east-1') }}") -> dict:
    """Retrieve a secret from AWS Secrets Manager."""
    client = boto3.client("secretsmanager", region_name=region)

    try:
        response = client.get_secret_value(SecretId=secret_id)
    except ClientError as e:
        error_code = e.response["Error"]["Code"]
        if error_code == "DecryptionFailureException":
            raise Exception("Secrets Manager can't decrypt the secret using the provided KMS key.")
        elif error_code == "InternalServiceErrorException":
            raise Exception("An error occurred on the server side.")
        elif error_code == "InvalidParameterException":
            raise Exception("Invalid parameter value provided.")
        elif error_code == "InvalidRequestException":
            raise Exception("Invalid request - parameter value not valid for current state.")
        elif error_code == "ResourceNotFoundException":
            raise Exception(f"Secret '{secret_id}' not found.")
        else:
            raise e

    if "SecretString" in response:
        return json.loads(response["SecretString"])
    else:
        import base64

        return json.loads(base64.b64decode(response["SecretBinary"]))


def main():
    parser = argparse.ArgumentParser(description="Retrieve secret from AWS Secrets Manager")
    parser.add_argument("--secret-id", required=True, help="Secret ID or ARN")
    parser.add_argument("--output", required=True, help="Output file path")
    parser.add_argument("--format", default="json", choices=["json", "env", "shell"], help="Output format")
    parser.add_argument("--region", default="{{ aws_region | default('us-east-1') }}", help="AWS region")

    args = parser.parse_args()

    try:
        secret = get_secret(args.secret_id, args.region)

        if args.format == "json":
            output = json.dumps(secret, indent=2)
        elif args.format == "env":
            output = "\n".join(f"{k}={v}" for k, v in secret.items())
        elif args.format == "shell":
            output = "\n".join(f"export {k}='{v}'" for k, v in secret.items())

        with open(args.output, "w") as f:
            f.write(output + "\n")

        print(f"Secret written to {args.output}")

    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
