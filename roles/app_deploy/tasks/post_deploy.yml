# Post-deployment Tasks
---
- name: Run post-deployment commands
  ansible.builtin.command:
    cmd: "{{ item }}"
    chdir: "{{ app_deploy_dir }}/current"
  become: true
  become_user: "{{ app_user | default(app_name) }}"
  environment: "{{ app_env_vars | default({}) }}"
  loop: "{{ app_post_deploy_commands | default([]) }}"
  when: app_post_deploy_commands is defined

- name: Collect static files (Django)
  ansible.builtin.command:
    cmd: "{{ app_deploy_dir }}/shared/venv/bin/python manage.py collectstatic --noinput"
    chdir: "{{ app_deploy_dir }}/current"
  become: true
  become_user: "{{ app_user | default(app_name) }}"
  environment: "{{ app_env_vars | default({}) }}"
  when: app_framework == 'django'

- name: Compile assets (Rails)
  ansible.builtin.command:
    cmd: "bundle exec rake assets:precompile"
    chdir: "{{ app_deploy_dir }}/current"
  become: true
  become_user: "{{ app_user | default(app_name) }}"
  environment:
    RAILS_ENV: "{{ app_rails_env | default('production') }}"
  when: app_framework == 'rails'

- name: Clear application cache
  ansible.builtin.command:
    cmd: "{{ app_cache_clear_command }}"
    chdir: "{{ app_deploy_dir }}/current"
  become: true
  become_user: "{{ app_user | default(app_name) }}"
  when: app_cache_clear_command is defined

- name: Health check
  ansible.builtin.uri:
    url: "{{ app_health_check_url }}"
    method: GET
    status_code: 200
    timeout: 30
  register: health_check
  retries: 5
  delay: 10
  until: health_check.status == 200
  when: app_health_check_url is defined

- name: Send deployment notification (Slack)
  community.general.slack:
    token: "{{ vault_slack_webhook_url }}"
    msg: "Deployed {{ app_name }} version {{ app_version | default('latest') }} to {{ environment_name }}"
    channel: "{{ app_slack_channel | default('#deployments') }}"
  when:
    - vault_slack_webhook_url is defined
    - app_notify_slack | default(false)
  delegate_to: localhost
  become: false
