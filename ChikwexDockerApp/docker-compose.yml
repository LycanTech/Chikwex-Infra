# ChikwexDockerApp - Docker Compose Configuration
# Multi-tier application with Frontend, Backend, Database, Cache, and Reverse Proxy

version: '3.8'

services:
  # ===========================================
  # Nginx Reverse Proxy - Entry Point
  # ===========================================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: chikwex-nginx
    ports:
      - "80:80"
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - chikwex-frontend
      - chikwex-backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================
  # Frontend - React Application
  # ===========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: chikwex-frontend
    networks:
      - chikwex-frontend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # Backend - Flask API
  # ===========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: chikwex-backend
    environment:
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-appdb}
      - DB_USER=${DB_USER:-appuser}
      - DB_PASSWORD=${DB_PASSWORD:-apppassword}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - FLASK_DEBUG=${FLASK_DEBUG:-false}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - chikwex-backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================
  # Database - PostgreSQL
  # ===========================================
  db:
    image: postgres:15-alpine
    container_name: chikwex-db
    environment:
      - POSTGRES_DB=${DB_NAME:-appdb}
      - POSTGRES_USER=${DB_USER:-appuser}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-apppassword}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - chikwex-backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-appuser} -d ${DB_NAME:-appdb}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================
  # Cache - Redis
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: chikwex-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - chikwex-backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

# ===========================================
# Networks - Isolated communication
# ===========================================
networks:
  chikwex-frontend:
    driver: bridge
    name: chikwex-frontend-net
  chikwex-backend:
    driver: bridge
    name: chikwex-backend-net

# ===========================================
# Volumes - Persistent data storage
# ===========================================
volumes:
  postgres_data:
    name: chikwex-postgres-data
  redis_data:
    name: chikwex-redis-data
