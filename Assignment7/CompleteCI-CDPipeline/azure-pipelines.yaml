# ================================================================
# Azure DevOps CI/CD Pipeline for Chikwex-EShopz (with Helm)
# ================================================================

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - Assignment7/CompleteCI-CDPipeline/microservices/**
      - Assignment7/CompleteCI-CDPipeline/frontend/**
      - Assignment7/CompleteCI-CDPipeline/k8s/**
      - Assignment7/CompleteCI-CDPipeline/helm/**

pr:
  branches:
    include:
      - main

variables:
  AWS_REGION: 'us-east-1'
  ECR_REGISTRY: '866934333672.dkr.ecr.us-east-1.amazonaws.com'
  EKS_CLUSTER_NAME: 'chikwex-eshopz-eks'
  NAMESPACE: 'chikwex-eshopz'
  HELM_CHART_PATH: 'Assignment7/CompleteCI-CDPipeline/helm/chikwex-eshopz'

stages:
  # ================================================================
  # STAGE 1: Build and Test
  # ================================================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildMicroservices
        displayName: 'Build Microservices'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            user-service:
              SERVICE_NAME: 'user-service'
            product-service:
              SERVICE_NAME: 'product-service'
            cart-service:
              SERVICE_NAME: 'cart-service'
            payment-service:
              SERVICE_NAME: 'payment-service'
            order-service:
              SERVICE_NAME: 'order-service'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Install Node.js'

          - script: |
              cd Assignment7/CompleteCI-CDPipeline/microservices/$(SERVICE_NAME)
              npm install
            displayName: 'Install dependencies'

          - script: |
              cd Assignment7/CompleteCI-CDPipeline/microservices/$(SERVICE_NAME)
              npm test -- --passWithNoTests || true
            displayName: 'Run tests'

      - job: BuildFrontend
        displayName: 'Build Frontend'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Install Node.js'

          - script: |
              cd Assignment7/CompleteCI-CDPipeline/frontend
              npm install
              npm run build
            displayName: 'Build frontend'

  # ================================================================
  # STAGE 2: Build Docker Images
  # ================================================================
  - stage: DockerBuild
    displayName: 'Build Docker Images'
    dependsOn: Build
    jobs:
      - job: BuildImages
        displayName: 'Build & Push Images'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            user-service:
              SERVICE_NAME: 'user-service'
              SERVICE_PATH: 'microservices/user-service'
            product-service:
              SERVICE_NAME: 'product-service'
              SERVICE_PATH: 'microservices/product-service'
            cart-service:
              SERVICE_NAME: 'cart-service'
              SERVICE_PATH: 'microservices/cart-service'
            payment-service:
              SERVICE_NAME: 'payment-service'
              SERVICE_PATH: 'microservices/payment-service'
            order-service:
              SERVICE_NAME: 'order-service'
              SERVICE_PATH: 'microservices/order-service'
            frontend:
              SERVICE_NAME: 'frontend'
              SERVICE_PATH: 'frontend'
        steps:
          - script: |
              # Install AWS CLI
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install --update

              # Configure AWS credentials
              aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID)
              aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY)
              aws configure set default.region $(AWS_REGION)

              # Login to ECR
              aws ecr get-login-password --region $(AWS_REGION) | docker login --username AWS --password-stdin $(ECR_REGISTRY)
            displayName: 'Configure AWS & Login to ECR'
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

          - script: |
              cd Assignment7/CompleteCI-CDPipeline/$(SERVICE_PATH)
              docker build -t $(ECR_REGISTRY)/chikwex-eshopz/$(SERVICE_NAME):$(Build.BuildId) \
                           -t $(ECR_REGISTRY)/chikwex-eshopz/$(SERVICE_NAME):latest .
            displayName: 'Build Docker image'

          - script: |
              docker push $(ECR_REGISTRY)/chikwex-eshopz/$(SERVICE_NAME):$(Build.BuildId)
              docker push $(ECR_REGISTRY)/chikwex-eshopz/$(SERVICE_NAME):latest
            displayName: 'Push to ECR'
            condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  # ================================================================
  # STAGE 3: Deploy to EKS with Helm
  # ================================================================
  - stage: Deploy
    displayName: 'Deploy with Helm'
    dependsOn: DockerBuild
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToEKS
        displayName: 'Deploy to EKS with Helm'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: HelmInstaller@1
                  inputs:
                    helmVersionToInstall: '3.13.0'
                  displayName: 'Install Helm'

                - script: |
                    # Install AWS CLI
                    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                    unzip -q awscliv2.zip
                    sudo ./aws/install --update

                    # Configure AWS credentials
                    aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID)
                    aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY)
                    aws configure set default.region $(AWS_REGION)

                    # Update kubeconfig
                    aws eks update-kubeconfig --name $(EKS_CLUSTER_NAME) --region $(AWS_REGION)

                    # Lint Helm chart
                    helm lint $(HELM_CHART_PATH)

                    # Deploy with Helm
                    helm upgrade --install chikwex-eshopz $(HELM_CHART_PATH) \
                      --namespace $(NAMESPACE) \
                      --set global.imageRegistry=$(ECR_REGISTRY)/chikwex-eshopz \
                      --set services.userService.image.tag=$(Build.BuildId) \
                      --set services.productService.image.tag=$(Build.BuildId) \
                      --set services.cartService.image.tag=$(Build.BuildId) \
                      --set services.paymentService.image.tag=$(Build.BuildId) \
                      --set services.orderService.image.tag=$(Build.BuildId) \
                      --set frontend.image.tag=$(Build.BuildId) \
                      --wait \
                      --timeout 10m

                    # Verify deployment
                    echo "Helm Release Status:"
                    helm status chikwex-eshopz -n $(NAMESPACE)

                    echo "Pod Status:"
                    kubectl get pods -n $(NAMESPACE)

                    echo "Helm History:"
                    helm history chikwex-eshopz -n $(NAMESPACE)
                  displayName: 'Deploy with Helm'
                  env:
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

  # ================================================================
  # STAGE 4: Integration Tests
  # ================================================================
  - stage: IntegrationTests
    displayName: 'Integration Tests'
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: SmokeTests
        displayName: 'Run Smoke Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              # Install AWS CLI
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install --update

              # Configure AWS credentials
              aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID)
              aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY)
              aws configure set default.region $(AWS_REGION)

              # Update kubeconfig
              aws eks update-kubeconfig --name $(EKS_CLUSTER_NAME) --region $(AWS_REGION)

              # Get ALB URL
              ALB_URL=$(kubectl get ingress chikwex-eshopz-ingress -n $(NAMESPACE) -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
              echo "Testing at: http://$ALB_URL"

              # Test endpoints
              echo "Testing Frontend..."
              curl -f http://$ALB_URL/ || echo "Frontend test skipped"

              echo "Testing Products API..."
              curl -f http://$ALB_URL/api/products || echo "Products API test skipped"

              echo "==================================="
              echo "All smoke tests completed!"
              echo "==================================="

              # Show Helm release info
              helm history chikwex-eshopz -n $(NAMESPACE)
            displayName: 'Run smoke tests'
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
