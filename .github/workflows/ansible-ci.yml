# Ansible CI/CD Pipeline
# Validates, tests, and deploys Ansible playbooks
name: Ansible CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'roles/**'
      - 'playbooks/**'
      - 'group_vars/**'
      - 'inventories/**'
      - 'molecule/**'
      - 'requirements.yml'
      - '.github/workflows/ansible-ci.yml'

  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'roles/**'
      - 'playbooks/**'
      - 'group_vars/**'
      - 'inventories/**'
      - 'molecule/**'
      - 'requirements.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy:
        description: 'Run deployment after tests'
        required: false
        default: false
        type: boolean

env:
  ANSIBLE_FORCE_COLOR: "1"
  PY_COLORS: "1"

jobs:
  lint:
    name: Lint Ansible Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint yamllint

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r requirements.yml

      - name: Run yamllint
        run: |
          yamllint -c .yamllint.yml .
        continue-on-error: true

      - name: Run ansible-lint
        run: |
          ansible-lint playbooks/ roles/
        continue-on-error: true

      - name: Syntax check playbooks
        run: |
          for playbook in playbooks/*.yml; do
            echo "Checking $playbook"
            ansible-playbook --syntax-check "$playbook" -i inventories/dev/hosts.yml
          done

  molecule-test:
    name: Molecule Test
    runs-on: ubuntu-latest
    needs: lint

    strategy:
      fail-fast: false
      matrix:
        role:
          - common
          - nginx
          - postgresql
          - security

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible molecule molecule-plugins[docker] docker

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r requirements.yml

      - name: Run Molecule tests for ${{ matrix.role }}
        run: |
          cd roles/${{ matrix.role }}
          if [ -d "molecule" ]; then
            molecule test
          else
            echo "No molecule tests for ${{ matrix.role }}, running syntax check"
            ansible-playbook --syntax-check ../../playbooks/site.yml -i ../../inventories/dev/hosts.yml
          fi
        env:
          MOLECULE_DISTRO: amazonlinux:2023

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install ansible bandit

      - name: Check for hardcoded secrets
        run: |
          # Check for potential secrets in YAML files
          grep -r -E "(password|secret|key|token):\s*['\"]?[^{]" \
            --include="*.yml" --include="*.yaml" \
            --exclude-dir=".git" \
            --exclude="*vault*" \
            . || true

      - name: Check vault files are encrypted
        run: |
          for file in $(find . -name "*vault*.yml" -type f); do
            if head -1 "$file" | grep -q "^\$ANSIBLE_VAULT"; then
              echo "✓ $file is encrypted"
            else
              echo "✗ WARNING: $file may not be encrypted!"
            fi
          done

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [molecule-test, security-scan]
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment: development

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible boto3 botocore

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r requirements.yml

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Create vault password file
        run: echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass

      - name: Run Ansible playbook (dry-run)
        run: |
          ansible-playbook playbooks/site.yml \
            -i inventories/dev/aws_ec2.yml \
            --vault-password-file .vault_pass \
            --check --diff
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"

      - name: Run Ansible playbook
        if: github.event.inputs.deploy == 'true' || github.event_name == 'push'
        run: |
          ansible-playbook playbooks/site.yml \
            -i inventories/dev/aws_ec2.yml \
            --vault-password-file .vault_pass
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"

      - name: Clean up
        if: always()
        run: rm -f .vault_pass

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [molecule-test, security-scan]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible boto3 botocore

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r requirements.yml

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: us-east-1

      - name: Create vault password file
        run: echo "${{ secrets.ANSIBLE_VAULT_PASSWORD_PROD }}" > .vault_pass

      - name: Run Ansible playbook (dry-run)
        run: |
          ansible-playbook playbooks/site.yml \
            -i inventories/prod/aws_ec2.yml \
            --vault-password-file .vault_pass \
            --check --diff

      - name: Manual approval required
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: chikwex-admin
          minimum-approvals: 1
          issue-title: "Production deployment approval required"

      - name: Run Ansible playbook
        run: |
          ansible-playbook playbooks/site.yml \
            -i inventories/prod/aws_ec2.yml \
            --vault-password-file .vault_pass
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"

      - name: Clean up
        if: always()
        run: rm -f .vault_pass

      - name: Notify on success
        if: success()
        run: |
          echo "Production deployment completed successfully!"
          # Add Slack/Teams notification here

      - name: Notify on failure
        if: failure()
        run: |
          echo "Production deployment failed!"
          # Add Slack/Teams notification here
