# Application Deployment Playbook
# Deploys applications to target servers with zero-downtime
---
- name: Deploy application
  hosts: appservers
  become: true
  gather_facts: true
  serial: "{{ deploy_serial | default('50%') }}"

  vars:
    # Deployment defaults - override in group_vars or command line
    app_name: "{{ lookup('env', 'APP_NAME') | default('chikwex-app', true) }}"
    app_version: "{{ lookup('env', 'APP_VERSION') | default('latest', true) }}"

  pre_tasks:
    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          Deploying {{ app_name }} version {{ app_version }}
          Target: {{ inventory_hostname }}
          Environment: {{ environment_name }}

    - name: Verify deployment prerequisites
      ansible.builtin.assert:
        that:
          - app_name is defined
          - app_version is defined or app_git_repo is defined
        fail_msg: "Missing required deployment variables"

    - name: Take server out of load balancer (if applicable)
      ansible.builtin.debug:
        msg: "Would remove {{ inventory_hostname }} from load balancer"
      when: remove_from_lb | default(false)
      tags:
        - lb

  roles:
    - role: app_deploy
      tags:
        - deploy
        - app

  post_tasks:
    - name: Verify application health
      ansible.builtin.uri:
        url: "{{ app_health_check_url | default('http://localhost:8000/health') }}"
        method: GET
        status_code: 200
        timeout: 30
      register: health_check
      retries: 5
      delay: 10
      until: health_check.status == 200
      when: app_health_check_url is defined

    - name: Add server back to load balancer
      ansible.builtin.debug:
        msg: "Would add {{ inventory_hostname }} back to load balancer"
      when: remove_from_lb | default(false)
      tags:
        - lb

    - name: Display deployment result
      ansible.builtin.debug:
        msg: |
          Deployment completed!
          Application: {{ app_name }}
          Version: {{ app_version }}
          Host: {{ inventory_hostname }}
          Status: {{ 'Healthy' if (health_check.status | default(0)) == 200 else 'Check manually' }}


- name: Rolling deployment to web servers
  hosts: webservers
  become: true
  gather_facts: true
  serial: 1

  vars:
    app_name: "{{ lookup('env', 'APP_NAME') | default('chikwex-app', true) }}"
    app_version: "{{ lookup('env', 'APP_VERSION') | default('latest', true) }}"

  tasks:
    - name: Reload Nginx to pick up new application
      ansible.builtin.service:
        name: nginx
        state: reloaded
      when: reload_nginx | default(true)
